# ImpoOS

64-битная операционная система с поддержкой ring3 терминала (TTY), аналогичного Linux.

## Описание

ImpoOS - это операционная система, разработанная для изучения низкоуровневого программирования и архитектуры ОС. Система поддерживает:

- **Long Mode (64-bit)** - работа в 64-битном режиме x86-64
- **TTY подсистема** - терминальный интерфейс с буферизацией ввода/вывода
- **Системные вызовы** - механизм взаимодействия между ring3 (пользовательский режим) и ring0 (режим ядра)
- **Обработка клавиатуры** - поддержка ввода с клавиатуры через прерывания
- **Модель задач** - базовая поддержка пользовательских процессов в ring3

## Архитектура

### Уровни привилегий (Rings)

- **Ring 0 (Kernel Mode)** - режим ядра, полный доступ к системе
- **Ring 3 (User Mode)** - пользовательский режим, ограниченный доступ, работа через системные вызовы

### Компоненты системы

```
┌─────────────────────────────────────────┐
│         User Programs (Ring 3)          │
│  ┌───────────────────────────────────┐  │
│  │  user_program.c                   │  │
│  │  - syscall(SYS_READ)              │  │
│  │  - syscall(SYS_WRITE)             │  │
│  └──────────────┬────────────────────┘  │
└─────────────────┼───────────────────────┘
                  │ syscall/sysret
┌─────────────────▼───────────────────────┐
│         Kernel (Ring 0)                 │
│  ┌───────────────────────────────────┐  │
│  │  syscall.c / syscall.asm          │  │
│  │  - Обработка системных вызовов    │  │
│  └──────────────┬────────────────────┘  │
│  ┌──────────────▼────────────────────┐  │
│  │  tty.c / tty.h                    │  │
│  │  - Буферизация ввода/вывода       │  │
│  │  - Canonical режим                │  │
│  └──────────────┬────────────────────┘  │
│  ┌──────────────▼────────────────────┐  │
│  │  keyboard.c                       │  │
│  │  - Обработка прерываний клавиатуры│  │
│  └──────────────┬────────────────────┘  │
│  ┌──────────────▼────────────────────┐  │
│  │  terminal.c                       │  │
│  │  - Вывод на VGA экран             │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## Структура проекта

```
ImpoOS/
├── src/
│   ├── boot.asm              # Загрузчик (32-bit)
│   ├── long_mode_init.asm    # Переход в 64-bit режим
│   ├── kernel.c              # Точка входа ядра
│   ├── gdt.c                 # Global Descriptor Table (сегменты)
│   ├── idt.c                 # Interrupt Descriptor Table
│   ├── pic.c                 # Программируемый контроллер прерываний
│   ├── interrupt.asm         # Обработчики прерываний
│   ├── keyboard.c            # Обработчик клавиатуры
│   ├── terminal.c            # Низкоуровневый вывод на VGA
│   ├── tty.c / tty.h         # TTY подсистема (ring3 терминал)
│   ├── syscall.c / syscall.h # Системные вызовы
│   ├── syscall.asm           # Ассемблерная часть syscall
│   ├── task.c / task.h       # Модель задач/процессов
│   ├── task.asm              # Переход в ring3
│   └── user_program.c        # Пример пользовательской программы
├── linker.ld                 # Скрипт линковки
├── grub.cfg                  # Конфигурация GRUB
└── Makefile                  # Система сборки
```

## Системные вызовы

Система поддерживает следующие системные вызовы:

- **SYS_READ (0)** - чтение из TTY
  ```c
  size_t read = syscall(SYS_READ, fd, buffer, count);
  ```

- **SYS_WRITE (1)** - запись в TTY
  ```c
  size_t written = syscall(SYS_WRITE, fd, buffer, count);
  ```

- **SYS_EXIT (2)** - завершение программы
  ```c
  syscall(SYS_EXIT, exit_code, 0, 0);
  ```

### Использование системных вызовов

```c
static inline uint64_t syscall(uint64_t num, uint64_t arg1, uint64_t arg2, uint64_t arg3) {
    uint64_t ret;
    __asm__ volatile (
        "syscall"
        : "=a" (ret)
        : "a" (num), "D" (arg1), "S" (arg2), "d" (arg3)
        : "rcx", "r11", "memory"
    );
    return ret;
}
```

## Сборка и запуск

### Требования

- `gcc` (компилятор C)
- `nasm` (ассемблер)
- `ld` (линковщик)
- `grub-mkrescue` (создание ISO образа)
- `qemu-system-x86_64` (эмулятор)

### Сборка

```bash
make
```

Это создаст файл `os.iso` с загрузочным образом системы.

### Запуск в QEMU

```bash
make run
```

Или вручную:

```bash
qemu-system-x86_64 -cdrom os.iso -m 512M -serial stdio -no-reboot
```

### Очистка

```bash
make clean
```

## TTY подсистема

TTY (Teletypewriter) - это подсистема терминального ввода/вывода, аналогичная Linux tty. Подробное описание реализации см. в [CHANGELOG.md](CHANGELOG.md).

### Основные возможности

- **Буферизация ввода** - символы с клавиатуры буферизуются до чтения программой
- **Canonical режим** - обработка строк (backspace, enter, etc.)
- **Эхо ввода** - отображение нажатых клавиш на экране
- **API для ring3** - программы могут читать/писать через системные вызовы

## Разработка

### Добавление нового системного вызова

1. Добавьте номер в `src/syscall.h`:
   ```c
   #define SYS_NEW_CALL 3
   ```

2. Обработайте в `src/syscall.c`:
   ```c
   case SYS_NEW_CALL:
       // Ваша логика
       syscall_return_value = result;
       break;
   ```

3. Используйте в пользовательской программе:
   ```c
   syscall(SYS_NEW_CALL, arg1, arg2, arg3);
   ```

## Статус проекта

- ✅ Базовая загрузка и инициализация
- ✅ GDT с поддержкой ring0 и ring3
- ✅ IDT и обработка прерываний
- ✅ Обработка клавиатуры
- ✅ TTY подсистема
- ✅ Системные вызовы (syscall/sysret)
- ✅ Модель задач для ring3
- ⏳ Полноценное управление процессами
- ⏳ Планировщик задач
- ⏳ Файловая система
- ⏳ Множественные TTY

## Лицензия

Образовательный проект.

## Авторы

Разработано для изучения архитектуры операционных систем.

